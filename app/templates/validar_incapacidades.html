{% extends "base.html" %}

{% block title %}Validar Incapacidad #{{ incapacidad.id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="mb-3">
            <a href="{{ url_for('incapacidades.dashboard_auxiliar') }}" class="btn btn-secondary">
                &larr; Volver al Dashboard
            </a>
        </div>

        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="bi bi-clipboard-check"></i>
                    Validacion de Documentacion - Incapacidad #{{ incapacidad.id }}
                </h3>
            </div>
            <div class="card-body">
                <!-- Informacion del Colaborador -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Colaborador</h5>
                        <p class="mb-1"><strong>{{ incapacidad.usuario.nombre }}</strong></p>
                        <p class="text-muted mb-0">{{ incapacidad.usuario.email }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Detalles de la Incapacidad</h5>
                        <p class="mb-1"><strong>Tipo:</strong> {{ incapacidad.tipo }}</p>
                        <p class="mb-1">
                            <strong>Periodo:</strong> 
                            {{ incapacidad.fecha_inicio.strftime('%d/%m/%Y') }} - 
                            {{ incapacidad.fecha_fin.strftime('%d/%m/%Y') }}
                        </p>
                        <p class="mb-0">
                            <strong>Dias:</strong> 
                            <span class="badge bg-secondary">{{ incapacidad.dias }} dias</span>
                        </p>
                    </div>
                </div>

                <hr>

                <!-- Validacion Automatica (UC10) -->
                <h5>
                    <i class="bi bi-robot"></i>
                    Validacion Automatica de Requisitos
                </h5>
                <div class="alert {% if validacion.todos_documentos %}alert-success{% else %}alert-warning{% endif %}">
                    <h6><strong>Checklist de Documentos Obligatorios:</strong></h6>
                    <ul class="mb-2">
                        <li>
                            {% if validacion.certificado_presente %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <strong>Certificado de Incapacidad:</strong> Presente ✅
                            {% else %}
                                <i class="bi bi-x-circle-fill text-danger"></i>
                                <strong>Certificado de Incapacidad:</strong> FALTANTE ❌ (Obligatorio)
                            {% endif %}
                        </li>
                        <li>
                            {% if validacion.epicrisis_requerida %}
                                {% if validacion.epicrisis_presente %}
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                    <strong>Epicrisis:</strong> Presente ✅
                                {% else %}
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                    <strong>Epicrisis:</strong> FALTANTE ❌ (Requerida para este caso)
                                {% endif %}
                            {% else %}
                                <i class="bi bi-info-circle-fill text-info"></i>
                                <strong>Epicrisis:</strong> No requerida para este caso
                                {% if validacion.epicrisis_presente %}
                                    (Presente de todas formas ✅)
                                {% endif %}
                            {% endif %}
                        </li>
                    </ul>
                    
                    {% if validacion.advertencias %}
                    <hr class="my-2">
                    <h6 class="text-danger"><strong>⚠️ Advertencias:</strong></h6>
                    <ul class="mb-0">
                        {% for adv in validacion.advertencias %}
                        <li class="text-danger">{{ adv }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    
                    {% if validacion.recomendaciones %}
                    <hr class="my-2">
                    <h6 class="text-success"><strong>✓ Estado:</strong></h6>
                    <ul class="mb-0">
                        {% for rec in validacion.recomendaciones %}
                        <li class="text-success">{{ rec }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>

                <hr>

                <!-- Documentos Adjuntos para Revision -->
                <h5>
                    <i class="bi bi-file-earmark-text"></i>
                    Documentos Adjuntos para Revision
                </h5>
                {% if incapacidad.documentos %}
                <div class="row mb-4">
                    {% for doc in incapacidad.documentos %}
                    <div class="col-md-6 mb-3">
                        <div class="documento-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1">
                                        <strong>
                                            {% if doc.tipo_documento == 'certificado' %}
                                                �� Certificado de Incapacidad
                                            {% else %}
                                                �� Epicrisis
                                            {% endif %}
                                        </strong>
                                    </p>
                                    <p class="mb-0 text-muted small">{{ doc.nombre_archivo }}</p>
                                    <p class="mb-0 text-muted small">
                                        Cargado: {{ doc.fecha_carga.strftime('%d/%m/%Y %H:%M') }}
                                    </p>
                                </div>
                                <div>
                                    <a href="{{ url_for('documentos.descargar', documento_id=doc.id) }}" 
                                       class="btn btn-sm btn-primary" target="_blank">
                                        <i class="bi bi-download"></i> Ver/Descargar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>No hay documentos adjuntos</strong>
                </div>
                {% endif %}

                <hr>

                <!-- Checklist Manual -->
                <h5>
                    <i class="bi bi-list-check"></i>
                    Checklist de Validacion Manual
                </h5>
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check1">
                            <label class="form-check-label" for="check1">
                                Los documentos son legibles y de calidad suficiente
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check2">
                            <label class="form-check-label" for="check2">
                                Las fechas en el certificado coinciden con las registradas
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check3">
                            <label class="form-check-label" for="check3">
                                El certificado es original (no fotocopia)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check4">
                            <label class="form-check-label" for="check4">
                                Los datos del colaborador son correctos
                            </label>
                        </div>
                        <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" id="check5">
                            <label class="form-check-label" for="check5">
                                No hay signos de alteracion o falsificacion
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Formulario de Accion -->
                <form method="POST" id="formValidacion">
                    {% if validacion.todos_documentos %}
                    <!-- Documentacion completa - Puede aprobar -->
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Documentacion completa:</strong> Todos los documentos obligatorios estan presentes.
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" name="accion" value="completar_revision" 
                                class="btn btn-success btn-lg" id="btnCompletar">
                            <i class="bi bi-check-lg"></i> Marcar Documentacion como Completa
                        </button>
                        <button type="button" class="btn btn-warning" 
                                data-bs-toggle="collapse" data-bs-target="#formSolicitar">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Solicitar Documentos Adicionales
                        </button>
                    </div>
                    
                    <!-- Formulario colapsable para solicitar documentos -->
                    <div class="collapse mt-3" id="formSolicitar">
                        <div class="card">
                            <div class="card-body">
                                <h6>Observaciones sobre documentos faltantes:</h6>
                                <textarea class="form-control mb-2" name="observaciones" rows="3" 
                                          placeholder="Describa que documentos adicionales se requieren..."></textarea>
                                <button type="submit" name="accion" value="solicitar_documentos" 
                                        class="btn btn-warning">
                                    <i class="bi bi-send"></i> Enviar Solicitud
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% else %}
                    <!-- Documentacion incompleta - No puede aprobar -->
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle-fill"></i>
                        <strong>No se puede completar la validacion:</strong> 
                        Faltan documentos obligatorios. Debe notificar al colaborador.
                    </div>
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">
                            <strong>Observaciones para el colaborador:</strong>
                        </label>
                        <textarea class="form-control" name="observaciones" id="observaciones" 
                                  rows="4" required
                                  placeholder="Especifique claramente que documentos faltan y por que...">Los siguientes documentos son requeridos:
{% for adv in validacion.advertencias %}
- {{ adv }}
{% endfor %}</textarea>
                        <div class="form-text">
                            El colaborador recibira este mensaje. Sea claro y especifico.
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" name="accion" value="solicitar_documentos" 
                                class="btn btn-warning btn-lg">
                            <i class="bi bi-send"></i> 
                            Notificar Documentos Faltantes al Colaborador
                        </button>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validar que todos los checks esten marcados antes de completar
document.getElementById('btnCompletar')?.addEventListener('click', function(e) {
    const checks = document.querySelectorAll('input[type="checkbox"]');
    const todosChecked = Array.from(checks).every(check => check.checked);
    
    if (!todosChecked) {
        e.preventDefault();
        alert('⚠️ Por favor, verifique todos los items del checklist manual antes de continuar.');
        
        // Resaltar checks no marcados
        checks.forEach(check => {
            if (!check.checked) {
                check.parentElement.style.backgroundColor = '#fff3cd';
                check.parentElement.style.padding = '5px';
                check.parentElement.style.borderRadius = '5px';
            }
        });
    } else {
        if (!confirm('¿Esta seguro de que la documentacion esta completa y correcta?\n\nEsto permitira aprobar o rechazar la incapacidad.')) {
            e.preventDefault();
        }
    }
});

// Limpiar resaltado cuando se marque un check
document.querySelectorAll('input[type="checkbox"]').forEach(check => {
    check.addEventListener('change', function() {
        if (this.checked) {
            this.parentElement.style.backgroundColor = '';
            this.parentElement.style.padding = '';
        }
    });
});
</script>
{% endblock %}