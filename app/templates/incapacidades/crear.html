{% extends "base.html" %}

{% block title %}Registrar Incapacidad{% endblock %}

{% block content %}
<div class="registrar-incapacidad-container">
    <div class="row">
        <div class="col-12 col-xl-10 offset-xl-1">
            
            <!-- Header -->
            <div class="page-header d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <a href="{{ url_for('incapacidades.mis_incapacidades') }}" class="btn-back">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <div>
                        <h2 class="mb-1">
                            <i class="bi bi-file-earmark-plus me-2"></i>
                            Registrar Nueva Incapacidad
                        </h2>
                        <p class="text-muted mb-0" style="font-size: 14px;">
                            Complete el formulario para registrar su solicitud de incapacidad
                        </p>
                    </div>
                </div>
            </div>

            <!-- Alertas de validación del servidor -->
            <div id="serverErrors" style="display: none;" class="validation-alert mb-4">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Errores de validación</strong>
                    <ul id="serverErrorsList" class="mb-0 mt-2"></ul>
                </div>
            </div>

            <form method="POST" enctype="multipart/form-data" id="formIncapacidad">
                
                <!-- Tarjeta de Información Básica -->
                <div class="form-card">
                    <div class="form-card-header">
                        <div class="form-card-icon">
                            <i class="bi bi-info-circle-fill"></i>
                        </div>
                        <div>
                            <h4>Información Básica</h4>
                            <p>Datos principales de la incapacidad</p>
                        </div>
                    </div>
                    
                    <div class="form-card-body">
                        <!-- Tipo de Incapacidad -->
                        <div class="form-group-modern">
                            <label for="tipo" class="form-label-modern">
                                <i class="bi bi-tag-fill"></i>
                                <span>Tipo de Incapacidad</span>
                                <span class="required-mark">*</span>
                            </label>
                            <select class="form-control-modern" id="tipo" name="tipo" required>
                                <option value="">-- Seleccione un tipo --</option>
                                <option value="Enfermedad General">Enfermedad General</option>
                                <option value="Accidente Laboral">Accidente Laboral</option>
                                <option value="Accidente de Tránsito">Accidente de Tránsito</option>
                                <option value="Licencia de Maternidad">Licencia de Maternidad</option>
                                <option value="Licencia de Paternidad">Licencia de Paternidad</option>
                            </select>
                            <div class="form-help">
                                <i class="bi bi-lightbulb"></i>
                                Seleccione el tipo para ver los documentos requeridos
                            </div>
                        </div>

                        <!-- Fechas -->
                        <div class="form-row">
                            <div class="form-group-modern">
                                <label for="fecha_inicio" class="form-label-modern">
                                    <i class="bi bi-calendar-event"></i>
                                    <span>Fecha de Inicio</span>
                                    <span class="required-mark">*</span>
                                </label>
                                <input type="date" class="form-control-modern" id="fecha_inicio" name="fecha_inicio" required>
                            </div>
                            <div class="form-group-modern">
                                <label for="fecha_fin" class="form-label-modern">
                                    <i class="bi bi-calendar-check"></i>
                                    <span>Fecha de Fin</span>
                                    <span class="required-mark">*</span>
                                </label>
                                <input type="date" class="form-control-modern" id="fecha_fin" name="fecha_fin" required>
                            </div>
                        </div>

                        <!-- Días calculados -->
                        <div id="diasCalculados" class="dias-calculados-card" style="display: none;">
                            <div class="dias-icon">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <div class="dias-content">
                                <div class="dias-label">Duración de la Incapacidad</div>
                                <div class="dias-value">
                                    <span id="numeroDias">0</span> día<span id="diasPlural">s</span>
                                </div>
                                <div class="dias-periodo">
                                    Del <strong id="fechaInicioText">--/--/----</strong> al <strong id="fechaFinText">--/--/----</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UC5: Panel de Documentos Requeridos Dinámico -->
                <div id="documentos-requeridos" class="form-card" style="display: none;">
                    <div class="form-card-header">
                        <div class="form-card-icon form-card-icon-success">
                            <i class="bi bi-file-earmark-check"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h4>Documentos Requeridos</h4>
                            <p>Verificación de documentación necesaria</p>
                        </div>
                        <div class="progress-badge">
                            <i class="bi bi-check-circle-fill"></i>
                            <span id="progress-text">0 de 0</span>
                        </div>
                    </div>
                    
                    <div class="form-card-body">
                        <!-- Barra de progreso -->
                        <div class="progress-bar-modern mb-4">
                            <div class="progress-bar-fill" id="progress-bar" style="width: 0%">
                                <span class="progress-bar-percentage" id="progress-percentage">0%</span>
                            </div>
                        </div>
                        
                        <!-- Lista dinámica de documentos -->
                        <div id="checklist-documentos" class="checklist-container">
                            <!-- Se llena dinámicamente con JavaScript -->
                        </div>
                        
                        <!-- Alertas de validación -->
                        <div id="validation-alerts" class="mt-3">
                            <!-- Se llenan dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Información inicial cuando no hay tipo seleccionado -->
                <div id="info-inicial" class="form-card">
                    <div class="form-card-header">
                        <div class="form-card-icon form-card-icon-info">
                            <i class="bi bi-file-earmark"></i>
                        </div>
                        <div>
                            <h4>Documentos Requeridos</h4>
                            <p>Información sobre documentación necesaria</p>
                        </div>
                    </div>
                    <div class="form-card-body">
                        <div class="info-message">
                            <i class="bi bi-info-circle-fill"></i>
                            <div>
                                <strong>Información</strong>
                                <p>Seleccione un tipo de incapacidad para ver los documentos requeridos.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta de Adjuntar Documentos -->
                <div class="form-card">
                    <div class="form-card-header">
                        <div class="form-card-icon form-card-icon-warning">
                            <i class="bi bi-paperclip"></i>
                        </div>
                        <div>
                            <h4>Adjuntar Documentos</h4>
                            <p>Carga de archivos (opcional en registro inicial)</p>
                        </div>
                    </div>
                    
                    <div class="form-card-body">
                        <!-- UC6: Información sobre documentos opcionales -->
                        <div id="info-documentos-opcional" class="info-message info-message-warning mb-4">
                            <i class="bi bi-info-circle-fill"></i>
                            <div>
                                <strong>Importante</strong>
                                <p>La carga de documentos es <strong>OPCIONAL</strong> en el registro inicial.
                                Si no tiene todos los documentos listos, puede registrar la incapacidad ahora y Gestión Humana le solicitará
                                los documentos faltantes posteriormente.</p>
                            </div>
                        </div>

                        <!-- Campos de documentos dinámicos -->
                        <div id="campos-documentos">
                            <!-- Certificado de Incapacidad (siempre visible) -->
                            <div class="documento-field-modern" id="field-certificado">
                                <label for="certificado" class="documento-label" id="label-certificado">
                                    <div class="documento-label-header">
                                        <div class="documento-icon">
                                            <i class="bi bi-file-earmark-medical"></i>
                                        </div>
                                        <div>
                                            <span class="documento-nombre">Certificado de Incapacidad</span>
                                            <span class="documento-badge documento-badge-opcional" id="badge-certificado">Opcional</span>
                                        </div>
                                    </div>
                                </label>
                                <input type="file" class="documento-input-modern" id="certificado" name="certificado" 
                                       accept=".pdf,.jpg,.jpeg,.png" data-tipo="CERTIFICADO_INCAPACIDAD" 
                                       data-nombre="Certificado de Incapacidad"
                                       onchange="onDocumentoChange(this)">
                                <div class="documento-help">
                                    <i class="bi bi-info-circle"></i>
                                    Formato: PDF, JPG, PNG. Máximo: 10MB
                                </div>
                                <div class="preview-container" id="preview-certificado" style="display: none;"></div>
                                <div class="invalid-feedback-modern" id="error-certificado"></div>
                            </div>

                            <!-- Otros campos se muestran dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Indicador de progreso de envío -->
                <div id="uploadProgress" style="display: none;" class="upload-progress-card mb-4">
                    <div class="spinner-container">
                        <div class="spinner-modern"></div>
                    </div>
                    <div>
                        <strong>Procesando incapacidad...</strong>
                        <p class="mb-0">Por favor espere, estamos guardando su información.</p>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="action-buttons-row mb-5">
                    <a href="{{ url_for('incapacidades.mis_incapacidades') }}" class="btn-action-large btn-action-secondary">
                        <i class="bi bi-x-circle"></i>
                        <span>Cancelar</span>
                    </a>
                    <button type="submit" class="btn-action-large btn-action-primary" id="btnSubmit">
                        <i class="bi bi-check-circle"></i>
                        <span>Registrar Incapacidad</span>
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-modern">
            <div class="modal-header-modern modal-header-success">
                <div class="modal-icon-success">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h5 class="modal-title-modern" id="modalConfirmacionLabel">
                    ¡Incapacidad Registrada!
                </h5>
            </div>
            <div class="modal-body-modern">
                <div class="success-icon-container mb-4">
                    <div class="success-icon-circle">
                        <i class="bi bi-file-earmark-check"></i>
                    </div>
                </div>
                <h4 class="modal-subtitle mb-4">Su incapacidad ha sido registrada exitosamente</h4>
                
                <div class="codigo-card mb-4">
                    <div class="codigo-card-header">
                        <i class="bi bi-qr-code"></i>
                        <span>Código de Radicación</span>
                    </div>
                    <div class="codigo-card-body">
                        <div class="codigo-value" id="codigoRadicacion">---</div>
                        <button class="btn-copy-codigo" onclick="copiarCodigo()">
                            <i class="bi bi-clipboard"></i>
                            <span>Copiar código</span>
                        </button>
                    </div>
                </div>

                <div class="proximos-pasos-card">
                    <div class="proximos-pasos-header">
                        <i class="bi bi-list-check"></i>
                        <span>Próximos pasos</span>
                    </div>
                    <ol class="proximos-pasos-list">
                        <li>
                            <i class="bi bi-1-circle-fill"></i>
                            <span>Guarde su código de radicación para futuras consultas</span>
                        </li>
                        <li>
                            <i class="bi bi-2-circle-fill"></i>
                            <span>Recibirá un email de confirmación</span>
                        </li>
                        <li>
                            <i class="bi bi-3-circle-fill"></i>
                            <span>Gestión Humana validará los documentos adjuntos</span>
                        </li>
                        <li>
                            <i class="bi bi-4-circle-fill"></i>
                            <span>Será notificado del resultado de la validación</span>
                        </li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer-modern">
                <a href="{{ url_for('incapacidades.mis_incapacidades') }}" 
                   class="btn-modal btn-modal-primary" 
                   id="btnVerMisIncapacidades"
                   data-url="{{ url_for('incapacidades.mis_incapacidades') }}">
                    <i class="bi bi-list-ul"></i>
                    <span>Ver Mis Incapacidades</span>
                </a>
                <button type="button" 
                        class="btn-modal btn-modal-secondary" 
                        id="btnRegistrarOtra">
                    <i class="bi bi-plus-circle"></i>
                    <span>Registrar Otra</span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ==================================================
   REGISTRAR INCAPACIDAD - ESTILOS MODERNOS
   ================================================== */

.registrar-incapacidad-container {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Header */
.page-header {
    animation: slideInLeft 0.4s ease;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.page-header h2 {
    color: #1f2937;
    font-weight: 700;
    font-size: 28px;
}

.page-header i {
    color: #3b82f6;
}

.btn-back {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: white;
    border: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #6b7280;
    transition: all 0.3s ease;
    text-decoration: none;
}

.btn-back:hover {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-color: #3b82f6;
    transform: translateX(-5px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Validation Alert */
.validation-alert {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 2px solid #fca5a5;
    border-radius: 16px;
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.validation-alert i {
    font-size: 28px;
    color: #dc2626;
    flex-shrink: 0;
}

.validation-alert strong {
    display: block;
    color: #1f2937;
    font-size: 15px;
    margin-bottom: 4px;
}

.validation-alert ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.validation-alert li {
    color: #374151;
    font-size: 14px;
    padding: 4px 0;
}

.validation-alert li::before {
    content: '•';
    color: #dc2626;
    font-weight: bold;
    margin-right: 8px;
}

/* Form Cards */
.form-card {
    background: white;
    border-radius: 16px;
    margin-bottom: 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 1px solid rgba(0, 0, 0, 0.05);
    animation: fadeInScale 0.5s ease backwards;
}

.form-card:nth-child(2) { animation-delay: 0.1s; }
.form-card:nth-child(3) { animation-delay: 0.2s; }
.form-card:nth-child(4) { animation-delay: 0.3s; }
.form-card:nth-child(5) { animation-delay: 0.4s; }

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.form-card-header {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 24px;
    border-bottom: 2px solid #f3f4f6;
}

.form-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    color: #1e40af;
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.15);
    flex-shrink: 0;
}

.form-card-icon-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.form-card-icon-warning {
    background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
    color: #9a3412;
}

.form-card-icon-info {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
}

.form-card-header h4 {
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 4px;
    font-size: 18px;
}

.form-card-header p {
    color: #6b7280;
    margin-bottom: 0;
    font-size: 14px;
}

.form-card-body {
    padding: 24px;
}

/* Progress Badge */
.progress-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
    white-space: nowrap;
}

.progress-badge i {
    font-size: 16px;
}

/* Modern Form Groups */
.form-group-modern {
    margin-bottom: 24px;
}

.form-label-modern {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 10px;
    font-size: 15px;
}

.form-label-modern i {
    color: #3b82f6;
    font-size: 18px;
}

.required-mark {
    color: #ef4444;
    font-weight: 700;
    margin-left: 4px;
}

.form-control-modern {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.3s ease;
    background: white;
}

.form-control-modern:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.form-control-modern:hover {
    border-color: #3b82f6;
}

.form-help {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    color: #6b7280;
    font-size: 13px;
}

.form-help i {
    color: #3b82f6;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

/* Días Calculados Card */
.dias-calculados-card {
    display: flex;
    gap: 20px;
    padding: 24px;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px solid #93c5fd;
    border-radius: 14px;
    margin-top: 16px;
    animation: slideInRight 0.5s ease;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.dias-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: white;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.dias-content {
    flex: 1;
}

.dias-label {
    font-size: 13px;
    font-weight: 600;
    color: #1e40af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.dias-value {
    font-size: 36px;
    font-weight: 800;
    color: #1e3a8a;
    line-height: 1;
    margin-bottom: 8px;
}

.dias-periodo {
    font-size: 14px;
    color: #1e40af;
}

.dias-periodo strong {
    color: #1e3a8a;
}

/* Progress Bar Modern */
.progress-bar-modern {
    width: 100%;
    height: 32px;
    background: #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 16px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 16px;
    position: relative;
    overflow: hidden;
}

.progress-bar-fill::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-bar-percentage {
    font-size: 13px;
    font-weight: 700;
    color: white;
    position: relative;
    z-index: 1;
    white-space: nowrap;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Checklist Container */
.checklist-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.documento-checklist-item {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    transition: all 0.3s ease;
}

.documento-checklist-item:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
}

.documento-checklist-item .bi-check-circle-fill {
    color: #10b981;
}

.documento-checklist-item .bi-circle {
    color: #d1d5db;
}

.documento-checklist-item .badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
}

.documento-checklist-item .bg-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
    color: #92400e;
    border: 1px solid #fbbf24;
}

.documento-checklist-item .bg-info {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
    color: #1e40af;
    border: 1px solid #60a5fa;
}

.documento-checklist-item .bg-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
    color: #065f46;
    border: 1px solid #34d399;
}

.documento-checklist-item .bg-light {
    background: #f3f4f6 !important;
    color: #6b7280;
    border: 1px solid #d1d5db;
}

/* Info Messages */
.info-message {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px solid #93c5fd;
    border-radius: 14px;
}

.info-message i {
    font-size: 24px;
    color: #1e40af;
    flex-shrink: 0;
}

.info-message strong {
    display: block;
    color: #1f2937;
    font-size: 15px;
    margin-bottom: 4px;
}

.info-message p {
    color: #374151;
    margin: 0;
    font-size: 14px;
    line-height: 1.6;
}

.info-message-warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border-color: #fbbf24;
}

.info-message-warning i {
    color: #d97706;
}

/* Documento Field Modern */
.documento-field-modern {
    padding: 20px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 14px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
}

.documento-field-modern:hover {
    background: white;
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
}

.documento-label {
    cursor: pointer;
    margin-bottom: 12px;
    display: block;
}

.documento-label-header {
    display: flex;
    align-items: center;
    gap: 12px;
}

.documento-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #1e40af;
}

.documento-nombre {
    font-weight: 700;
    color: #1f2937;
    font-size: 15px;
}

.documento-badge {
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
}

.documento-badge-opcional {
    background: #e5e7eb;
    color: #6b7280;
}

.documento-badge-requerido {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.documento-input-modern {
    width: 100%;
    padding: 12px;
    border: 2px dashed #cbd5e1;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.documento-input-modern:hover {
    border-color: #3b82f6;
    background: #f8fafc;
}

.documento-input-modern:focus {
    outline: none;
    border-style: solid;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.documento-input-modern.is-valid {
    border-color: #10b981;
    border-style: solid;
}

.documento-input-modern.is-valid:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
}

.documento-input-modern.is-invalid {
    border-color: #ef4444;
    border-style: solid;
}

.documento-input-modern.is-invalid:focus {
    border-color: #ef4444;
    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
}

.documento-help {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    color: #6b7280;
    font-size: 13px;
}

.documento-help i {
    color: #3b82f6;
}

.preview-container {
    margin-top: 12px;
    padding: 12px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
}

.invalid-feedback-modern {
    display: none;
    margin-top: 8px;
    color: #dc2626;
    font-size: 13px;
    font-weight: 600;
}

/* Upload Progress Card */
.upload-progress-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 24px;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px solid #93c5fd;
    border-radius: 16px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.9; }
}

.spinner-container {
    flex-shrink: 0;
}

.spinner-modern {
    width: 40px;
    height: 40px;
    border: 4px solid #bfdbfe;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.upload-progress-card strong {
    display: block;
    color: #1e40af;
    font-size: 16px;
    margin-bottom: 4px;
}

.upload-progress-card p {
    color: #1e40af;
    font-size: 14px;
}

/* Action Buttons */
.action-buttons-row {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.btn-action-large {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 16px 32px;
    border-radius: 14px;
    border: none;
    font-weight: 700;
    font-size: 15px;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.btn-action-large::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.5s, height 0.5s;
}

.btn-action-large:hover::before {
    width: 400px;
    height: 400px;
}

.btn-action-large i {
    font-size: 20px;
    transition: transform 0.3s ease;
}

.btn-action-large:hover i {
    transform: scale(1.2);
}

.btn-action-large:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.btn-action-large:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn-action-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.btn-action-primary:hover:not(:disabled) {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
}

.btn-action-secondary {
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    color: #1f2937;
}

.btn-action-secondary:hover {
    background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
}

/* Modal Modern Styles */
.modal-modern {
    border-radius: 20px;
    overflow: hidden;
    border: none;
}

.modal-header-modern {
    padding: 32px;
    text-align: center;
    border-bottom: none;
    position: relative;
}

.modal-header-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
}

.modal-icon-success {
    width: 80px;
    height: 80px;
    margin: 0 auto 16px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: white;
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes scaleIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}

.modal-title-modern {
    font-size: 28px;
    font-weight: 800;
    color: #065f46;
    margin: 0;
}

.modal-body-modern {
    padding: 32px;
}

.success-icon-container {
    text-align: center;
}

.success-icon-circle {
    width: 120px;
    height: 120px;
    margin: 0 auto;
    border-radius: 50%;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    color: #059669;
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
}

.modal-subtitle {
    text-align: center;
    font-weight: 700;
    color: #1f2937;
    font-size: 20px;
}

/* Codigo Card */
.codigo-card {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px solid #93c5fd;
    border-radius: 16px;
    overflow: hidden;
}

.codigo-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 20px;
    background: rgba(59, 130, 246, 0.1);
    border-bottom: 2px solid #93c5fd;
    font-weight: 700;
    color: #1e40af;
    font-size: 14px;
}

.codigo-card-header i {
    font-size: 20px;
}

.codigo-card-body {
    padding: 24px;
    text-align: center;
}

.codigo-value {
    font-size: 32px;
    font-weight: 800;
    color: #1e3a8a;
    font-family: 'Courier New', monospace;
    letter-spacing: 2px;
    margin-bottom: 16px;
}

.btn-copy-codigo {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: white;
    border: 2px solid #3b82f6;
    border-radius: 10px;
    color: #1e40af;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-copy-codigo:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-copy-codigo i {
    font-size: 16px;
}

/* Proximos Pasos Card */
.proximos-pasos-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #7dd3fc;
    border-radius: 16px;
    padding: 20px;
}

.proximos-pasos-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    font-weight: 700;
    color: #0c4a6e;
    font-size: 15px;
}

.proximos-pasos-header i {
    font-size: 22px;
    color: #0284c7;
}

.proximos-pasos-list {
    list-style: none;
    padding: 0;
    margin: 0;
    counter-reset: step-counter;
}

.proximos-pasos-list li {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 0;
    color: #374151;
    font-size: 14px;
    line-height: 1.6;
    border-bottom: 1px solid rgba(125, 211, 252, 0.3);
}

.proximos-pasos-list li:last-child {
    border-bottom: none;
}

.proximos-pasos-list li i {
    font-size: 20px;
    color: #0284c7;
    flex-shrink: 0;
}

.modal-footer-modern {
    padding: 24px 32px;
    background: #f9fafb;
    border-top: 2px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: center;
}

.btn-modal {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    border-radius: 12px;
    border: none;
    font-weight: 700;
    font-size: 15px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-modal i {
    font-size: 18px;
}

.btn-modal-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-modal-primary:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    color: white;
}

.btn-modal-secondary {
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    color: #1f2937;
}

.btn-modal-secondary:hover {
    background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
    transform: translateY(-2px);
}

/* Responsive */
@media (max-width: 768px) {
    .page-header > div {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .dias-calculados-card {
        flex-direction: column;
        text-align: center;
    }
    
    .dias-icon {
        margin: 0 auto;
    }
    
    .action-buttons-row {
        flex-direction: column-reverse;
    }
    
    .btn-action-large {
        width: 100%;
    }
    
    .modal-footer-modern {
        flex-direction: column;
    }
    
    .btn-modal {
        width: 100%;
        justify-content: center;
    }
}
</style>

{% endblock %}

{% block scripts %}
<script>
// UC5: Estado para control de documentos y validación
let documentosRequeridos = {};
let documentosCargados = {};
let validacionActual = null;

// Función para obtener descripción dinámica según el contexto
function obtenerDescripcionDocumento(tipo, tipoIncapacidad) {
  const config = tiposDocumento[tipo];
  if (!config) return 'Documento requerido';
  
  // Descripción específica para Epicrisis en Licencia de Paternidad
  if (tipo === 'EPICRISIS' && tipoIncapacidad === 'Licencia de Paternidad') {
    return 'Resumen médico que debe incluir las semanas de gestación al momento del parto';
  }
  
  // Descripción específica para Documento de Identidad en Licencia de Paternidad
  if ((tipo === 'DOCUMENTO_IDENTIDAD' || tipo === 'DOCUMENTO_IDENTIDAD_MADRE') && tipoIncapacidad === 'Licencia de Paternidad') {
    return 'Fotocopia del documento de identidad de la madre del menor';
  }
  
  return config.descripcion;
}

// Función para obtener nombre dinámico según el contexto
function obtenerNombreDocumento(tipo, tipoIncapacidad) {
  const config = tiposDocumento[tipo];
  if (!config) return 'Documento';
  
  // Nombre específico para Documento de Identidad en Licencia de Paternidad
  if ((tipo === 'DOCUMENTO_IDENTIDAD' || tipo === 'DOCUMENTO_IDENTIDAD_MADRE') && tipoIncapacidad === 'Licencia de Paternidad') {
    return 'Documento de Identidad de la Madre';
  }
  
  return config.nombre;
}

// Configuración de tipos de documento
const tiposDocumento = {
  'CERTIFICADO_INCAPACIDAD': {
    id: 'certificado',
    nombre: 'Certificado de Incapacidad',
    icono: 'bi-file-earmark-medical',
    descripcion: 'Certificado médico que establece la incapacidad'
  },
  'EPICRISIS': {
    id: 'epicrisis',
    nombre: 'Epicrisis',
    icono: 'bi-file-earmark-text',
    descripcion: 'Resumen médico de la atención hospitalaria'
  },
  'FURIPS': {
    id: 'furips',
    nombre: 'FURIPS',
    icono: 'bi-file-earmark-plus',
    descripcion: 'Formulario Único de Reclamación para accidentes de tránsito'
  },
  'CERTIFICADO_NACIDO_VIVO': {
    id: 'certificado_nacido_vivo',
    nombre: 'Certificado de Nacido Vivo',
    icono: 'bi-file-earmark-person',
    descripcion: 'Certificado emitido por la institución de salud'
  },
  'REGISTRO_CIVIL': {
    id: 'registro_civil',
    nombre: 'Registro Civil',
    icono: 'bi-file-earmark-text',
    descripcion: 'Registro Civil de Nacimiento del menor'
  },
  'DOCUMENTO_IDENTIDAD': {
    id: 'documento_identidad',
    nombre: 'Documento de Identidad',
    icono: 'bi-file-earmark-person',
    descripcion: 'Fotocopia del documento de identidad'
  },
  'DOCUMENTO_IDENTIDAD_MADRE': {
    id: 'documento_identidad_madre',
    nombre: 'Documento de Identidad de la Madre',
    icono: 'bi-file-earmark-person',
    descripcion: 'Fotocopia del documento de identidad de la madre'
  }
};

// Variable para indicar que NO se debe guardar borrador (después de envío exitoso)
let noGuardarBorrador = false;

document.addEventListener('DOMContentLoaded', function() {
  const tipoSelect = document.getElementById('tipo');
  const fechaInicio = document.getElementById('fecha_inicio');
  const fechaFin = document.getElementById('fecha_fin');
  const form = document.getElementById('formIncapacidad');
  
  // Listeners principales
  tipoSelect.addEventListener('change', onTipoChange);
  fechaInicio.addEventListener('change', calcularDias);
  fechaFin.addEventListener('change', calcularDias);
  form.addEventListener('submit', handleSubmit);
  
  // Listener para documentos existentes
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('documento-input')) {
      onDocumentoChange(e.target);
    }
  });
  
  // UC1-E5: Recuperar borrador si existe (SOLO si hay parámetro en URL que lo indique)
  // Esto previene que se recupere el borrador después de un registro exitoso
  const urlParams = new URLSearchParams(window.location.search);
  if (!urlParams.has('registro_exitoso')) {
    recuperarBorrador();
  } else {
    // Si viene de registro exitoso, eliminar cualquier borrador que pueda existir
    localStorage.removeItem(BORRADOR_KEY);
    console.log('Borrador eliminado - Página limpia después de registro exitoso');
  }
  
  // UC1-E5/E6: Guardar borrador automático cada 30 segundos
  setInterval(guardarBorradorAutomatico, 30000);
  
  // UC1-E6: Detectar conexión/desconexión
  window.addEventListener('online', onConexionRestaurada);
  window.addEventListener('offline', onConexionPerdida);
  
  // UC1-E5: Guardar borrador antes de cambiar de página (SOLO si NO está marcado para no guardar)
  window.addEventListener('beforeunload', function(e) {
    if (!noGuardarBorrador && formularioTieneDatos()) {
      guardarBorradorLocal();
    }
  });
});

// UC5: Función principal cuando cambia el tipo de incapacidad
async function onTipoChange() {
  const tipo = document.getElementById('tipo').value;
  
  if (!tipo) {
    mostrarInfoInicial();
    return;
  }
  
  // Calcular días si las fechas están establecidas
  calcularDias();
  
  // Obtener documentos requeridos del servidor
  await cargarDocumentosRequeridos(tipo);
  
  // Actualizar UI
  actualizarUIDocumentos();
}

// UC5: Cargar documentos requeridos desde API
async function cargarDocumentosRequeridos(tipo) {
  try {
    // Obtener días de incapacidad si están disponibles
    const dias = obtenerDiasIncapacidad();
    
    // Construir URL con parámetros
    let url = `/incapacidades/api/documentos-requeridos/${encodeURIComponent(tipo)}`;
    if (dias > 0) {
      url += `?dias=${dias}`;
    }
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    documentosRequeridos = data;
    
    console.log('Documentos requeridos cargados:', documentosRequeridos);
    
  } catch (error) {
    console.error('Error cargando documentos requeridos:', error);
    // Fallback a configuración estática
    usarConfiguracionEstatica(tipo);
  }
}

// Fallback a configuración estática si la API falla
function usarConfiguracionEstatica(tipo) {
  const configuracionEstatica = {
    'Enfermedad General': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'EPICRISIS'],
      condicionales: []
    },
    'Accidente Laboral': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'EPICRISIS'],
      condicionales: []
    },
    'Accidente de Tránsito': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'FURIPS'],
      condicionales: ['EPICRISIS']
    },
    'Licencia de Maternidad': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'CERTIFICADO_NACIDO_VIVO', 'REGISTRO_CIVIL'],
      condicionales: []
    },
    'Licencia de Paternidad': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'CERTIFICADO_NACIDO_VIVO', 'REGISTRO_CIVIL', 'DOCUMENTO_IDENTIDAD_MADRE'],
      condicionales: []
    }
  };
  
  documentosRequeridos = configuracionEstatica[tipo] || { obligatorios: [], condicionales: [] };
}

// UC5: Actualizar UI con documentos requeridos
function actualizarUIDocumentos() {
  // Ocultar info inicial y mostrar panel de documentos
  document.getElementById('info-inicial').style.display = 'none';
  document.getElementById('documentos-requeridos').style.display = 'block';
  
  // Limpiar estado de documentos que ya no son requeridos
  limpiarDocumentosNoRequeridos();
  
  // Renderizar checklist dinámico
  renderizarChecklistDocumentos();
  
  // Crear campos de entrada dinámicos
  crearCamposDocumentos();
  
  // Actualizar mensaje informativo
  actualizarMensajeInformativo();
  
  // Actualizar indicadores de progreso
  actualizarProgreso();
}

// Limpiar estado de documentos que ya no son requeridos
function limpiarDocumentosNoRequeridos() {
  // Obtener todos los documentos actualmente requeridos
  const documentosRequeridosActuales = [
    ...documentosRequeridos.obligatorios || [],
    ...documentosRequeridos.condicionales || []
  ];
  
  // Convertir tipos a IDs
  const idsRequeridos = documentosRequeridosActuales
    .map(tipo => tiposDocumento[tipo]?.id)
    .filter(Boolean);
  
  // Limpiar estado de documentos que ya no están requeridos
  Object.keys(documentosCargados).forEach(docId => {
    // Mantener solo el certificado y los documentos requeridos actuales
    if (docId !== 'certificado' && !idsRequeridos.includes(docId)) {
      // Verificar si el input todavía existe en el DOM
      const inputElement = document.getElementById(docId);
      if (!inputElement) {
        // Si el input ya no existe, limpiar su estado
        delete documentosCargados[docId];
        console.log(`✓ Limpiado estado de documento no requerido: ${docId}`);
      }
    }
  });
  
  // Además, verificar que los documentos marcados como cargados realmente tengan archivos
  idsRequeridos.forEach(docId => {
    const inputElement = document.getElementById(docId);
    if (inputElement && inputElement.files && inputElement.files.length === 0) {
      // Si el input existe pero no tiene archivo, marcar como no cargado
      if (documentosCargados[docId]) {
        delete documentosCargados[docId];
        console.log(`✓ Limpiado estado de documento sin archivo: ${docId}`);
      }
    }
  });
}

// UC5: Renderizar checklist dinámico de documentos
function renderizarChecklistDocumentos() {
  const container = document.getElementById('checklist-documentos');
  container.innerHTML = '';
  
  const todosDocumentos = [
    ...documentosRequeridos.obligatorios?.map(tipo => ({ tipo, obligatorio: true })) || [],
    ...documentosRequeridos.condicionales?.map(tipo => ({ tipo, obligatorio: false })) || []
  ];
  
  if (todosDocumentos.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle me-2"></i>
        No se encontraron requisitos específicos para este tipo de incapacidad.
      </div>
    `;
    return;
  }

  todosDocumentos.forEach(({ tipo, obligatorio }) => {
    const config = tiposDocumento[tipo];
    if (!config) return;
    
    // Verificar estado real del archivo en el input
    const inputElement = document.getElementById(config.id);
    const tieneArchivoReal = inputElement && inputElement.files && inputElement.files.length > 0;
    
    // Actualizar estado en documentosCargados basado en la realidad del DOM
    if (tieneArchivoReal) {
      documentosCargados[config.id] = true;
    } else {
      documentosCargados[config.id] = false;
    }
    
    const cargado = documentosCargados[config.id] || false;
    const checkIcon = cargado ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted';
    const badgeClass = obligatorio ? 'bg-warning' : 'bg-info';
    const badgeText = obligatorio ? 'Obligatorio' : 'Condicional';
    
    const item = document.createElement('div');
    item.className = 'border rounded p-3 mb-2 documento-checklist-item';
    item.setAttribute('data-tipo', tipo);
    
    item.innerHTML = `
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi ${checkIcon} fs-5 me-3" id="check-${config.id}"></i>
          <div>
            <div class="fw-bold">
              <i class="bi ${config.icono} me-2"></i>
              ${obtenerNombreDocumento(tipo, document.getElementById('tipo').value)}
              <span class="badge ${badgeClass} ms-2">${badgeText}</span>
            </div>
            <div class="text-muted small">${obtenerDescripcionDocumento(tipo, document.getElementById('tipo').value)}</div>
          </div>
        </div>
        <div class="status-indicator" id="status-${config.id}">
          ${cargado ? 
            '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Cargado</span>' : 
            '<span class="badge bg-light text-dark">Pendiente</span>'
          }
        </div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

// UC5: Crear campos de entrada dinámicos
function crearCamposDocumentos() {
  const container = document.getElementById('campos-documentos');
  
  // Mantener el certificado existente
  const certificadoField = document.getElementById('field-certificado');
  
  // Limpiar otros campos
  const camposExistentes = container.querySelectorAll('.documento-field-modern:not(#field-certificado)');
  camposExistentes.forEach(campo => campo.remove());
  
  const todosDocumentos = [
    ...documentosRequeridos.obligatorios?.map(tipo => ({ tipo, obligatorio: true })) || [],
    ...documentosRequeridos.condicionales?.map(tipo => ({ tipo, obligatorio: false })) || []
  ];
  
  // Actualizar badge del certificado para que sea consistente
  actualizarBadgeCertificado();
  
  todosDocumentos.forEach(({ tipo, obligatorio }) => {
    const config = tiposDocumento[tipo];
    if (!config || config.id === 'certificado') return; // Certificado ya existe
    
    const fieldId = `field-${config.id}`;
    
    // No duplicar campos existentes
    if (document.getElementById(fieldId)) return;
    
    const badgeClass = obligatorio ? 'documento-badge-requerido' : 'documento-badge-opcional';
    const badgeText = obligatorio ? 'Obligatorio' : 'Condicional';
    
    const field = document.createElement('div');
    field.className = 'documento-field-modern';
    field.id = fieldId;
    
    field.innerHTML = `
      <label for="${config.id}" class="documento-label">
        <div class="documento-label-header">
          <div class="documento-icon">
            <i class="bi ${config.icono}"></i>
          </div>
          <div class="flex-grow-1">
            <span class="documento-nombre">
              ${obtenerNombreDocumento(tipo, document.getElementById('tipo').value)}
            </span>
            <span class="documento-badge ${badgeClass}">${badgeText}</span>
          </div>
        </div>
      </label>
      <input type="file" class="documento-input-modern" id="${config.id}" 
             name="${config.id}" accept=".pdf,.jpg,.jpeg,.png" 
             data-tipo="${tipo}" data-nombre="${obtenerNombreDocumento(tipo, document.getElementById('tipo').value)}"
             onchange="onDocumentoChange(this)">
      <div class="documento-help">
        <i class="bi bi-info-circle"></i>
        <span>${obtenerDescripcionDocumento(tipo, document.getElementById('tipo').value)}. Formato: PDF, JPG, PNG. Máx: 10MB</span>
      </div>
      <div class="preview-container" id="preview-${config.id}" style="display: none;"></div>
      <div class="invalid-feedback-modern" id="error-${config.id}"></div>
    `;
    
    container.appendChild(field);
  });
}

// Función para actualizar badge del certificado de manera consistente
function actualizarBadgeCertificado() {
  const badgeElement = document.getElementById('badge-certificado');
  if (!badgeElement) return;
  
  // Verificar si certificado es obligatorio en los documentos requeridos
  const certificadoObligatorio = documentosRequeridos.obligatorios?.includes('CERTIFICADO_INCAPACIDAD') || false;
  
  if (certificadoObligatorio) {
    badgeElement.className = 'documento-badge documento-badge-requerido';
    badgeElement.textContent = 'Obligatorio';
  } else {
    badgeElement.className = 'documento-badge documento-badge-opcional';
    badgeElement.textContent = 'Condicional';
  }
}

// Función para actualizar mensaje informativo según documentos requeridos
function actualizarMensajeInformativo() {
  const infoElement = document.getElementById('info-documentos-opcional');
  if (!infoElement) return;
  
  const numObligatorios = documentosRequeridos.obligatorios?.length || 0;
  const numCondicionales = documentosRequeridos.condicionales?.length || 0;
  
  // Mostrar el elemento si hay un tipo seleccionado
  infoElement.style.display = 'block';
  
  let mensaje = '';
  
  if (numObligatorios > 0) {
    mensaje = `
      <i class="bi bi-info-circle-fill me-2"></i>
      <strong>Importante:</strong> Para este tipo de incapacidad hay <strong>${numObligatorios} documento(s) obligatorio(s)</strong>`;
    
    if (numCondicionales > 0) {
      mensaje += ` y ${numCondicionales} condicional(es)`;
    }
    
    mensaje += `. Sin embargo, la carga es <strong>OPCIONAL</strong> en el registro inicial. 
      Si no tiene todos los documentos listos, puede registrar la incapacidad ahora y Gestión Humana le solicitará
      los documentos faltantes posteriormente.`;
    
    infoElement.className = 'alert alert-info mb-4';
  } else {
    mensaje = `
      <i class="bi bi-info-circle-fill me-2"></i>
      <strong>Importante:</strong> La carga de documentos es <strong>OPCIONAL</strong> en el registro inicial.
      Si no tiene todos los documentos listos, puede registrar la incapacidad ahora y Gestión Humana le solicitará
      los documentos faltantes posteriormente.`;
    
    infoElement.className = 'alert alert-warning mb-4';
  }
  
  infoElement.innerHTML = mensaje;
}

// UC5: Manejar cambio en documentos
function onDocumentoChange(input) {
  const fieldId = input.id;
  const file = input.files[0];
  const tipo = input.getAttribute('data-tipo');
  
  // Limpiar validación previa
  input.classList.remove('is-valid', 'is-invalid');
  const errorElement = document.getElementById(`error-${fieldId}`);
  if (errorElement) {
    errorElement.style.display = 'none';
    errorElement.textContent = '';
  }
  
  if (file) {
    // Validar archivo
    const validation = validarArchivo(file);
    if (!validation.valido) {
      input.classList.add('is-invalid');
      if (errorElement) {
        errorElement.textContent = validation.error;
        errorElement.style.display = 'block';
      }
      const previewElement = document.getElementById(`preview-${fieldId}`);
      if (previewElement) previewElement.style.display = 'none';
      
      // Actualizar estado
      documentosCargados[fieldId] = false;
    } else {
      input.classList.add('is-valid');
      mostrarPreview(fieldId, file);
      
      // Actualizar estado
      documentosCargados[fieldId] = true;
    }
  } else {
    const previewElement = document.getElementById(`preview-${fieldId}`);
    if (previewElement) previewElement.style.display = 'none';
    documentosCargados[fieldId] = false;
  }
  
  // Actualizar UI
  actualizarEstadoDocumento(fieldId, tipo);
  actualizarProgreso();
  validarFormularioCompleto();
}

// UC5: Actualizar estado visual de documento
function actualizarEstadoDocumento(fieldId, tipo) {
  const cargado = documentosCargados[fieldId] || false;
  
  // Actualizar checklist
  const checkIcon = document.getElementById(`check-${fieldId}`);
  const statusIndicator = document.getElementById(`status-${fieldId}`);
  
  if (checkIcon) {
    checkIcon.className = cargado ? 
      'bi bi-check-circle-fill text-success fs-5 me-3' : 
      'bi bi-circle text-muted fs-5 me-3';
  }
  
  if (statusIndicator) {
    statusIndicator.innerHTML = cargado ?
      '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Cargado</span>' :
      '<span class="badge bg-light text-dark">Pendiente</span>';
  }
}

// UC5: Actualizar indicador de progreso
function actualizarProgreso() {
  const todosDocumentos = [
    ...documentosRequeridos.obligatorios?.map(tipo => tiposDocumento[tipo]?.id).filter(Boolean) || [],
    ...documentosRequeridos.condicionales?.map(tipo => tiposDocumento[tipo]?.id).filter(Boolean) || []
  ];
  
  const totalDocumentos = todosDocumentos.length;
  const documentosCargadosCount = todosDocumentos.filter(id => documentosCargados[id]).length;
  
  const porcentaje = totalDocumentos > 0 ? Math.round((documentosCargadosCount / totalDocumentos) * 100) : 0;
  
  // Actualizar texto
  const progressText = document.getElementById('progress-text');
  if (progressText) {
    progressText.textContent = `${documentosCargadosCount} de ${totalDocumentos} documentos`;
  }
  
  // Actualizar barra de progreso
  const progressBar = document.getElementById('progress-bar');
  if (progressBar) {
    progressBar.style.width = `${porcentaje}%`;
    progressBar.setAttribute('aria-valuenow', porcentaje);
  }
  
  // Actualizar porcentaje en el texto
  const progressPercentage = document.getElementById('progress-percentage');
  if (progressPercentage) {
    progressPercentage.textContent = `${porcentaje}%`;
    // Ocultar porcentaje si es muy pequeño (menos de 10%)
    progressPercentage.style.display = porcentaje < 10 ? 'none' : 'inline';
  }
  
  // Cambiar color según progreso - mantener gradiente verde
  if (progressBar) {
    // El gradiente verde ya está definido en CSS, no necesitamos cambiar clases
    progressBar.className = 'progress-bar-fill';
  }
}

// UC5: Validación del formulario antes del submit
function validarFormularioCompleto() {
  const alertContainer = document.getElementById('validation-alerts');
  alertContainer.innerHTML = '';
  
  // Verificar documentos obligatorios
  const obligatoriosFaltantes = [];
  
  if (documentosRequeridos.obligatorios) {
    documentosRequeridos.obligatorios.forEach(tipo => {
      const config = tiposDocumento[tipo];
      if (config && !documentosCargados[config.id]) {
        obligatoriosFaltantes.push(config.nombre);
      }
    });
  }
  
  // Mostrar alertas si hay documentos faltantes
  if (obligatoriosFaltantes.length > 0) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning';
    alert.innerHTML = `
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong>Documentos obligatorios pendientes:</strong>
      <ul class="mb-0 mt-2">
        ${obligatoriosFaltantes.map(nombre => `<li>${nombre}</li>`).join('')}
      </ul>
      <div class="small mt-2 text-muted">
        Puede registrar la incapacidad sin estos documentos. Gestión Humana los solicitará posteriormente.
      </div>
    `;
    alertContainer.appendChild(alert);
  } else {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success';
    alert.innerHTML = `
      <i class="bi bi-check-circle-fill me-2"></i>
      <strong>¡Todos los documentos obligatorios están cargados!</strong>
    `;
    alertContainer.appendChild(alert);
  }
  
  return obligatoriosFaltantes.length === 0;
}

// Funciones auxiliares
function mostrarInfoInicial() {
  document.getElementById('info-inicial').style.display = 'block';
  document.getElementById('documentos-requeridos').style.display = 'none';
  
  // Ocultar/resetear mensaje informativo
  const infoElement = document.getElementById('info-documentos-opcional');
  if (infoElement) {
    infoElement.style.display = 'none';
  }
  
  // Limpiar campos dinámicos
  const container = document.getElementById('campos-documentos');
  const camposExistentes = container.querySelectorAll('.documento-field-modern:not(#field-certificado)');
  camposExistentes.forEach(campo => campo.remove());
  
  // Resetear badge del certificado a su estado original
  const badgeElement = document.getElementById('badge-certificado');
  if (badgeElement) {
    badgeElement.className = 'documento-badge documento-badge-opcional';
    badgeElement.textContent = 'Opcional';
  }
  
  // Reset estado
  documentosRequeridos = {};
  documentosCargados = {};
}

function obtenerDiasIncapacidad() {
  const inicio = document.getElementById('fecha_inicio').value;
  const fin = document.getElementById('fecha_fin').value;
  
  if (inicio && fin) {
    const fechaInicio = new Date(inicio);
    const fechaFin = new Date(fin);
    const diff = fechaFin - fechaInicio;
    return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
  }
  
  return 0;
}

function calcularDias() {
  const inicio = document.getElementById('fecha_inicio').value;
  const fin = document.getElementById('fecha_fin').value;
  const container = document.getElementById('diasCalculados');
  
  if (inicio && fin) {
    const fechaInicio = new Date(inicio);
    const fechaFin = new Date(fin);
    const diff = fechaFin - fechaInicio;
    const dias = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
    
    if (dias > 0) {
      document.getElementById('numeroDias').textContent = dias;
      document.getElementById('fechaInicioText').textContent = formatearFecha(inicio);
      document.getElementById('fechaFinText').textContent = formatearFecha(fin);
      container.style.display = 'block';
      
      // Si ya hay un tipo seleccionado, recargar documentos con los días actualizados
      const tipo = document.getElementById('tipo').value;
      if (tipo) {
        cargarDocumentosRequeridos(tipo).then(() => {
          actualizarUIDocumentos();
        });
      }
    } else {
      container.style.display = 'none';
      alert('⚠️ La fecha de fin debe ser posterior a la fecha de inicio.');
    }
  } else {
    container.style.display = 'none';
  }
}

function mostrarPreview(fieldId, file) {
  const previewContainer = document.getElementById(`preview-${fieldId}`);
  const fileType = file.type;
  const fileSize = (file.size / 1024).toFixed(2); // KB
  
  previewContainer.innerHTML = '';
  previewContainer.style.display = 'block';
  
  const previewCard = document.createElement('div');
  previewCard.className = 'card border-success';
  previewCard.style.maxWidth = '400px';
  
  let previewContent = '';
  
  // Preview según tipo de archivo
  if (fileType.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      previewContent = `
        <div class="card-body p-2">
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <img src="${e.target.result}" alt="Preview" class="img-thumbnail" style="max-width: 120px; max-height: 120px;">
            </div>
            <div class="col">
              <div class="small">
                <strong>${file.name}</strong><br>
                <span class="text-muted">Tamaño: ${fileSize} KB</span><br>
                <span class="badge bg-success">Imagen válida</span>
              </div>
            </div>
          </div>
        </div>
      `;
      previewCard.innerHTML = previewContent;
    };
    reader.readAsDataURL(file);
  } else if (fileType === 'application/pdf') {
    previewContent = `
      <div class="card-body p-2">
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <i class="bi bi-file-pdf-fill text-danger" style="font-size: 4rem;"></i>
          </div>
          <div class="col">
            <div class="small">
              <strong>${file.name}</strong><br>
              <span class="text-muted">Tamaño: ${fileSize} KB</span><br>
              <span class="badge bg-success">PDF válido</span>
            </div>
          </div>
        </div>
      </div>
    `;
    previewCard.innerHTML = previewContent;
  } else {
    previewContent = `
      <div class="card-body p-2">
        <div class="small">
          <i class="bi bi-file-earmark-check text-success me-2"></i>
          <strong>${file.name}</strong> (${fileSize} KB)
        </div>
      </div>
    `;
    previewCard.innerHTML = previewContent;
  }
  
  previewContainer.appendChild(previewCard);
}

function handleSubmit(e) {
  e.preventDefault();
  
  // Limpiar errores previos
  document.getElementById('serverErrors').style.display = 'none';
  document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  
  // Validar fechas
  const fechaInicio = document.getElementById('fecha_inicio').value;
  const fechaFin = document.getElementById('fecha_fin').value;
  
  if (new Date(fechaFin) < new Date(fechaInicio)) {
    mostrarErroresServidor(['La fecha de fin debe ser posterior a la fecha de inicio']);
    return;
  }
  
  // UC5: Validación cliente opcional (no bloqueante)
  const todosCompletos = validarFormularioCompleto();
  
  if (!todosCompletos) {
    // Mostrar confirmación pero no bloquear
    if (!confirm('Hay documentos obligatorios pendientes. ¿Desea continuar? Gestión Humana los solicitará posteriormente.')) {
      return;
    }
  }
  
  // Mostrar indicador de progreso
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('btnSubmit').disabled = true;
  
  // Enviar formulario
  const formData = new FormData(this);
  
  fetch(this.action || window.location.href, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('btnSubmit').disabled = false;
    
    if (data.success) {
      // Marcar que NO se debe guardar más el borrador
      noGuardarBorrador = true;
      
      // UC1-E5/E6: Limpiar borrador INMEDIATAMENTE al registrar exitosamente
      localStorage.removeItem(BORRADOR_KEY);
      console.log('✅ Borrador eliminado - Registro exitoso');
      
      mostrarModalConfirmacion(data.codigo_radicacion);
    } else {
      mostrarErroresServidor(data.errors || ['Error al procesar la solicitud']);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('btnSubmit').disabled = false;
    mostrarErroresServidor(['Error de conexión. Por favor, intente nuevamente.']);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}

function mostrarErroresServidor(errores) {
  const container = document.getElementById('serverErrors');
  const lista = document.getElementById('serverErrorsList');
  
  lista.innerHTML = '';
  errores.forEach(error => {
    const li = document.createElement('li');
    li.textContent = error;
    lista.appendChild(li);
  });
  
  container.style.display = 'block';
}

function mostrarModalConfirmacion(codigoRadicacion) {
  // Asegurar que el borrador esté eliminado y NO se guarde más
  noGuardarBorrador = true;
  localStorage.removeItem(BORRADOR_KEY);
  
  document.getElementById('codigoRadicacion').textContent = codigoRadicacion;
  const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
  modal.show();
}

function copiarCodigo() {
  const codigo = document.getElementById('codigoRadicacion').textContent;
  navigator.clipboard.writeText(codigo).then(() => {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copiado!';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
      btn.innerHTML = originalHTML;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  });
}

// Funciones para limpiar borrador al navegar desde modal
function limpiarBorradorYRecargar() {
  noGuardarBorrador = true;
  localStorage.removeItem(BORRADOR_KEY);
  console.log('🔄 Borrador eliminado - Recargando página');
  // Recargar con parámetro para indicar que viene de registro exitoso
  window.location.href = window.location.pathname + '?registro_exitoso=1';
}

function limpiarBorradorYNavegar(event, url) {
  event.preventDefault();
  noGuardarBorrador = true;
  localStorage.removeItem(BORRADOR_KEY);
  console.log('🔗 Borrador eliminado - Navegando a:', url);
  window.location.href = url;
}

// Función de formateo de fecha
function formatearFecha(fecha) {
  const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(fecha).toLocaleDateString('es-ES', opciones);
}

// Función de validación de archivo
function validarArchivo(file) {
  const maxSize = 10 * 1024 * 1024; // 10MB
  const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
  
  if (!file) {
    return { valido: false, error: 'No se seleccionó ningún archivo' };
  }
  
  // UC1-E3: Validación de tamaño
  if (file.size > maxSize) {
    const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
    return { 
      valido: false, 
      error: `UC1-E3: Archivo muy grande. "${file.name}" pesa ${sizeMB}MB. Máximo: 10MB. Comprima el archivo o use PDF.`
    };
  }
  
  // UC1-E2: Validación de formato
  if (!allowedTypes.includes(file.type)) {
    return { 
      valido: false, 
      error: `UC1-E2: Formato inválido. Use PDF, JPG o PNG.` 
    };
  }
  
  return { valido: true };
}

// ============================================================================
// UC1-E5/E6: GESTIÓN DE BORRADORES Y PÉRDIDA DE CONEXIÓN
// ============================================================================

const BORRADOR_KEY = 'incapacidad_borrador';
const ARCHIVOS_KEY = 'incapacidad_archivos_info';

function formularioTieneDatos() {
  const tipo = document.getElementById('tipo').value;
  const fechaInicio = document.getElementById('fecha_inicio').value;
  const fechaFin = document.getElementById('fecha_fin').value;
  return tipo || fechaInicio || fechaFin || Object.keys(documentosCargados).length > 0;
}

function guardarBorradorLocal() {
  // NO guardar si está marcado para no guardar (después de envío exitoso)
  if (noGuardarBorrador) {
    console.log('⚠️ Guardado de borrador bloqueado - Formulario ya enviado');
    return;
  }
  
  if (!formularioTieneDatos()) return;
  
  const borrador = {
    tipo: document.getElementById('tipo').value,
    fecha_inicio: document.getElementById('fecha_inicio').value,
    fecha_fin: document.getElementById('fecha_fin').value,
    documentos_info: Object.keys(documentosCargados).filter(k => documentosCargados[k]).map(k => ({
      id: k,
      nombre: document.getElementById(k)?.files[0]?.name || 'archivo'
    })),
    timestamp: new Date().toISOString()
  };
  
  try {
    localStorage.setItem(BORRADOR_KEY, JSON.stringify(borrador));
    console.log('💾 UC1-E5/E6: Borrador guardado localmente');
  } catch (e) {
    console.error('Error guardando borrador:', e);
  }
}

function recuperarBorrador() {
  try {
    const borradorStr = localStorage.getItem(BORRADOR_KEY);
    if (!borradorStr) return;
    
    const borrador = JSON.parse(borradorStr);
    const ahora = new Date();
    const timestamp = new Date(borrador.timestamp);
    const horasTranscurridas = (ahora - timestamp) / (1000 * 60 * 60);
    
    // Solo recuperar si es menor a 24 horas
    if (horasTranscurridas > 24) {
      localStorage.removeItem(BORRADOR_KEY);
      return;
    }
    
    // Mostrar alerta de recuperación
    if (confirm(`UC1-E5: Se encontró un borrador guardado hace ${Math.round(horasTranscurridas)} hora(s). ¿Desea recuperarlo?`)) {
      document.getElementById('tipo').value = borrador.tipo || '';
      document.getElementById('fecha_inicio').value = borrador.fecha_inicio || '';
      document.getElementById('fecha_fin').value = borrador.fecha_fin || '';
      
      if (borrador.tipo) {
        onTipoChange();
      }
      
      if (borrador.fecha_inicio && borrador.fecha_fin) {
        calcularDias();
      }
      
      // Mostrar info de archivos que se perdieron
      if (borrador.documentos_info && borrador.documentos_info.length > 0) {
        const nombresArchivos = borrador.documentos_info.map(d => d.nombre).join(', ');
        alert(`Nota: Los archivos adjuntos (${nombresArchivos}) deben ser cargados nuevamente por seguridad.`);
      }
      
      console.log('UC1-E5: Borrador recuperado');
    }
    
    // Limpiar borrador después de recuperar o rechazar
    localStorage.removeItem(BORRADOR_KEY);
  } catch (e) {
    console.error('Error recuperando borrador:', e);
    localStorage.removeItem(BORRADOR_KEY);
  }
}

function guardarBorradorAutomatico() {
  // NO guardar si está marcado para no guardar o si no hay conexión
  if (noGuardarBorrador) {
    return;
  }
  
  if (formularioTieneDatos() && navigator.onLine) {
    guardarBorradorLocal();
  }
}

function onConexionPerdida() {
  // UC1-E6: Guardar borrador inmediatamente
  guardarBorradorLocal();
  
  // Mostrar alerta
  const alertDiv = document.createElement('div');
  alertDiv.id = 'alert-conexion';
  alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
  alertDiv.style.zIndex = '9999';
  alertDiv.innerHTML = `
    <i class="bi bi-wifi-off me-2"></i>
    <strong>UC1-E6:</strong> Sin conexión a Internet. Los datos se han guardado localmente.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alertDiv);
  
  console.log('UC1-E6: Conexión perdida, borrador guardado');
}

function onConexionRestaurada() {
  // Remover alerta de conexión
  const alertDiv = document.getElementById('alert-conexion');
  if (alertDiv) {
    alertDiv.remove();
  }
  
  // Mostrar alerta de reconexión
  const alertReconexion = document.createElement('div');
  alertReconexion.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
  alertReconexion.style.zIndex = '9999';
  alertReconexion.innerHTML = `
    <i class="bi bi-wifi me-2"></i>
    <strong>UC1-E6:</strong> Conexión restaurada. Puede continuar con el registro.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alertReconexion);
  
  setTimeout(() => alertReconexion.remove(), 5000);
  
  console.log('UC1-E6: Conexión restaurada');
}

// Event listeners para botones del modal de éxito
document.addEventListener('DOMContentLoaded', function() {
  const btnVerMisIncapacidades = document.getElementById('btnVerMisIncapacidades');
  const btnRegistrarOtra = document.getElementById('btnRegistrarOtra');
  
  if (btnVerMisIncapacidades) {
    btnVerMisIncapacidades.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.getAttribute('data-url');
      limpiarBorradorYNavegar(e, url);
    });
  }
  
  if (btnRegistrarOtra) {
    btnRegistrarOtra.addEventListener('click', function() {
      limpiarBorradorYRecargar();
    });
  }
});

</script>
{% endblock %}