{% extends "base.html" %}

{% block title %}Registrar Incapacidad{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">üìã Registrar Nueva Incapacidad</h3>
      </div>
      <div class="card-body">
        <!-- Alertas de validaci√≥n del servidor -->
        <div id="serverErrors" style="display: none;" class="alert alert-danger alert-dismissible fade show">
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          <strong>‚ùå Errores de validaci√≥n:</strong>
          <ul id="serverErrorsList" class="mb-0 mt-2"></ul>
        </div>

        <form method="POST" enctype="multipart/form-data" id="formIncapacidad">
          <!-- Tipo de Incapacidad -->
          <div class="mb-4">
            <label for="tipo" class="form-label fw-bold">Tipo de Incapacidad *</label>
            <select class="form-select" id="tipo" name="tipo" required>
              <option value="">-- Seleccione un tipo --</option>
              <option value="Enfermedad General">Enfermedad General</option>
              <option value="Accidente Laboral">Accidente Laboral</option>
              <option value="Accidente de Tr√°nsito">Accidente de Tr√°nsito</option>
              <option value="Licencia de Maternidad">Licencia de Maternidad</option>
              <option value="Licencia de Paternidad">Licencia de Paternidad</option>
            </select>
            <div class="form-text">Seleccione el tipo para ver los documentos requeridos</div>
          </div>

          <!-- Fechas -->
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label for="fecha_inicio" class="form-label fw-bold">Fecha de Inicio *</label>
              <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="fecha_fin" class="form-label fw-bold">Fecha de Fin *</label>
              <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" required>
            </div>
          </div>

          <!-- D√≠as calculados -->
          <div class="mb-4">
            <div class="alert alert-info" id="diasCalculados" style="display: none;">
              <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check fs-3 me-3"></i>
                <div>
                  <strong>D√≠as de incapacidad:</strong> <span id="numeroDias" class="fs-4 text-primary fw-bold">0</span> d√≠a(s)
                  <div class="small text-muted">Del <span id="fechaInicioText"></span> al <span id="fechaFinText"></span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- UC5: Panel de Documentos Requeridos Din√°mico -->
          <div class="mb-4" id="documentos-requeridos" style="display: none;">
            <div class="card border-info">
              <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìÑ Documentos Requeridos</h5>
                <div id="progress-indicator" class="badge bg-primary fs-6">
                  <i class="bi bi-file-earmark-check me-1"></i>
                  <span id="progress-text">0 de 0 documentos</span>
                </div>
              </div>
              <div class="card-body">
                <!-- Indicador de progreso visual -->
                <div class="progress mb-3" style="height: 8px;">
                  <div class="progress-bar" id="progress-bar" role="progressbar" 
                       style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                
                <!-- Lista din√°mica de documentos -->
                <div id="checklist-documentos">
                  <!-- Se llena din√°micamente con JavaScript -->
                </div>
                
                <!-- Alertas de validaci√≥n -->
                <div id="validation-alerts" class="mt-3">
                  <!-- Se llenan din√°micamente -->
                </div>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n inicial cuando no hay tipo seleccionado -->
          <div class="mb-4" id="info-inicial">
            <div class="card border-info">
              <div class="card-header bg-info bg-opacity-10">
                <h5 class="mb-0">üìÑ Documentos Requeridos</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info mb-0">
                  <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Seleccione un tipo de incapacidad para ver los documentos requeridos.
                </div>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- Secci√≥n de Documentos -->
          <h5 class="mb-3">üìé Adjuntar Documentos</h5>
          
          <!-- UC6: Informaci√≥n sobre documentos opcionales -->
          <div class="alert alert-warning mb-4" id="info-documentos-opcional">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Importante:</strong> La carga de documentos es <strong>OPCIONAL</strong> en el registro inicial.
            Si no tiene todos los documentos listos, puede registrar la incapacidad ahora y Gesti√≥n Humana le solicitar√°
            los documentos faltantes posteriormente.
          </div>

          <!-- Campos de documentos din√°micos -->
          <div id="campos-documentos">
            <!-- Certificado de Incapacidad (siempre visible) -->
            <div class="mb-4 documento-field" id="field-certificado">
              <label for="certificado" class="form-label fw-bold" id="label-certificado">
                <i class="bi bi-file-earmark-medical me-2"></i>
                Certificado de Incapacidad 
                <span class="badge bg-secondary ms-2" id="badge-certificado">Opcional</span>
              </label>
              <input type="file" class="form-control documento-input" id="certificado" name="certificado" 
                     accept=".pdf,.jpg,.jpeg,.png" data-tipo="CERTIFICADO_INCAPACIDAD" 
                     data-nombre="Certificado de Incapacidad">
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Formato: PDF, JPG, PNG. M√°x: 10MB
              </div>
              <div class="preview-container mt-2" id="preview-certificado" style="display: none;"></div>
              <div class="invalid-feedback"></div>
            </div>

            <!-- Otros campos se muestran din√°micamente -->
          </div>

          <hr class="my-4">

          <!-- Indicador de progreso de env√≠o -->
          <div id="uploadProgress" style="display: none;" class="mb-3">
            <div class="alert alert-info">
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <span>Procesando incapacidad... Por favor espere.</span>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
              <i class="bi bi-check-circle me-2"></i>Registrar Incapacidad
            </button>
            <a href="{{ url_for('incapacidades.mis_incapacidades') }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-2"></i>Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalConfirmacionLabel">
          <i class="bi bi-check-circle-fill me-2"></i>¬°Incapacidad Registrada!
        </h5>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-4">
          <i class="bi bi-file-earmark-check text-success" style="font-size: 4rem;"></i>
        </div>
        <h4 class="mb-3">Su incapacidad ha sido registrada exitosamente</h4>
        
        <div class="card border-primary mb-4">
          <div class="card-body">
            <p class="mb-2"><strong>C√≥digo de Radicaci√≥n:</strong></p>
            <h2 class="text-primary mb-0" id="codigoRadicacion" style="font-family: 'Courier New', monospace;">
              ---
            </h2>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="copiarCodigo()">
              <i class="bi bi-clipboard me-1"></i>Copiar c√≥digo
            </button>
          </div>
        </div>

        <div class="alert alert-info text-start">
          <strong>üìã Pr√≥ximos pasos:</strong>
          <ol class="mb-0 mt-2 small">
            <li>Guarde su c√≥digo de radicaci√≥n para futuras consultas</li>
            <li>Recibir√° un email de confirmaci√≥n</li>
            <li>Gesti√≥n Humana validar√° los documentos adjuntos</li>
            <li>Ser√° notificado del resultado de la validaci√≥n</li>
          </ol>
        </div>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('incapacidades.mis_incapacidades') }}" class="btn btn-primary">
          Ver Mis Incapacidades
        </a>
        <button type="button" class="btn btn-secondary" onclick="location.reload()">
          Registrar Otra
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// UC5: Estado para control de documentos y validaci√≥n
let documentosRequeridos = {};
let documentosCargados = {};
let validacionActual = null;

// Configuraci√≥n de tipos de documento
const tiposDocumento = {
  'CERTIFICADO_INCAPACIDAD': {
    id: 'certificado',
    nombre: 'Certificado de Incapacidad',
    icono: 'bi-file-earmark-medical',
    descripcion: 'Certificado m√©dico que establece la incapacidad'
  },
  'EPICRISIS': {
    id: 'epicrisis',
    nombre: 'Epicrisis',
    icono: 'bi-file-earmark-text',
    descripcion: 'Resumen m√©dico de la atenci√≥n hospitalaria'
  },
  'FURIPS': {
    id: 'furips',
    nombre: 'FURIPS',
    icono: 'bi-file-earmark-plus',
    descripcion: 'Formulario √önico de Reclamaci√≥n para accidentes de tr√°nsito'
  },
  'CERTIFICADO_NACIDO_VIVO': {
    id: 'certificado_nacido_vivo',
    nombre: 'Certificado de Nacido Vivo',
    icono: 'bi-file-earmark-person',
    descripcion: 'Certificado emitido por la instituci√≥n de salud'
  },
  'REGISTRO_CIVIL': {
    id: 'registro_civil',
    nombre: 'Registro Civil',
    icono: 'bi-file-earmark-text',
    descripcion: 'Registro Civil de Nacimiento del menor'
  },
  'DOCUMENTO_IDENTIDAD': {
    id: 'documento_identidad',
    nombre: 'Documento de Identidad',
    icono: 'bi-file-earmark-person',
    descripcion: 'Fotocopia del documento de identidad'
  },
  'DOCUMENTO_IDENTIDAD_MADRE': {
    id: 'documento_identidad_madre',
    nombre: 'Documento de Identidad de la Madre',
    icono: 'bi-file-earmark-person',
    descripcion: 'Fotocopia del documento de identidad de la madre'
  }
};

document.addEventListener('DOMContentLoaded', function() {
  const tipoSelect = document.getElementById('tipo');
  const fechaInicio = document.getElementById('fecha_inicio');
  const fechaFin = document.getElementById('fecha_fin');
  const form = document.getElementById('formIncapacidad');
  
  // Listeners principales
  tipoSelect.addEventListener('change', onTipoChange);
  fechaInicio.addEventListener('change', calcularDias);
  fechaFin.addEventListener('change', calcularDias);
  form.addEventListener('submit', handleSubmit);
  
  // Listener para documentos existentes
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('documento-input')) {
      onDocumentoChange(e.target);
    }
  });
});

// UC5: Funci√≥n principal cuando cambia el tipo de incapacidad
async function onTipoChange() {
  const tipo = document.getElementById('tipo').value;
  
  if (!tipo) {
    mostrarInfoInicial();
    return;
  }
  
  // Calcular d√≠as si las fechas est√°n establecidas
  calcularDias();
  
  // Obtener documentos requeridos del servidor
  await cargarDocumentosRequeridos(tipo);
  
  // Actualizar UI
  actualizarUIDocumentos();
}

// UC5: Cargar documentos requeridos desde API
async function cargarDocumentosRequeridos(tipo) {
  try {
    // Obtener d√≠as de incapacidad si est√°n disponibles
    const dias = obtenerDiasIncapacidad();
    
    // Construir URL con par√°metros
    let url = `/incapacidades/api/documentos-requeridos/${encodeURIComponent(tipo)}`;
    if (dias > 0) {
      url += `?dias=${dias}`;
    }
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    documentosRequeridos = data;
    
    console.log('Documentos requeridos cargados:', documentosRequeridos);
    
  } catch (error) {
    console.error('Error cargando documentos requeridos:', error);
    // Fallback a configuraci√≥n est√°tica
    usarConfiguracionEstatica(tipo);
  }
}

// Fallback a configuraci√≥n est√°tica si la API falla
function usarConfiguracionEstatica(tipo) {
  const configuracionEstatica = {
    'Enfermedad General': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'EPICRISIS'],
      condicionales: []
    },
    'Accidente Laboral': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'EPICRISIS'],
      condicionales: []
    },
    'Accidente de Tr√°nsito': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'FURIPS'],
      condicionales: ['EPICRISIS']
    },
    'Licencia de Maternidad': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'CERTIFICADO_NACIDO_VIVO', 'REGISTRO_CIVIL'],
      condicionales: []
    },
    'Licencia de Paternidad': {
      obligatorios: ['CERTIFICADO_INCAPACIDAD', 'CERTIFICADO_NACIDO_VIVO', 'REGISTRO_CIVIL', 'DOCUMENTO_IDENTIDAD_MADRE'],
      condicionales: []
    }
  };
  
  documentosRequeridos = configuracionEstatica[tipo] || { obligatorios: [], condicionales: [] };
}

// UC5: Actualizar UI con documentos requeridos
function actualizarUIDocumentos() {
  // Ocultar info inicial y mostrar panel de documentos
  document.getElementById('info-inicial').style.display = 'none';
  document.getElementById('documentos-requeridos').style.display = 'block';
  
  // Renderizar checklist din√°mico
  renderizarChecklistDocumentos();
  
  // Crear campos de entrada din√°micos
  crearCamposDocumentos();
  
  // Actualizar mensaje informativo
  actualizarMensajeInformativo();
  
  // Actualizar indicadores de progreso
  actualizarProgreso();
}

// UC5: Renderizar checklist din√°mico de documentos
function renderizarChecklistDocumentos() {
  const container = document.getElementById('checklist-documentos');
  container.innerHTML = '';
  
  const todosDocumentos = [
    ...documentosRequeridos.obligatorios?.map(tipo => ({ tipo, obligatorio: true })) || [],
    ...documentosRequeridos.condicionales?.map(tipo => ({ tipo, obligatorio: false })) || []
  ];
  
  if (todosDocumentos.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle me-2"></i>
        No se encontraron requisitos espec√≠ficos para este tipo de incapacidad.
      </div>
    `;
    return;
  }

  // Funci√≥n para obtener descripci√≥n din√°mica seg√∫n el contexto
  function obtenerDescripcionDocumento(tipo, tipoIncapacidad) {
    const config = tiposDocumento[tipo];
    if (!config) return 'Documento requerido';
    
    // Descripci√≥n espec√≠fica para Epicrisis en Licencia de Paternidad
    if (tipo === 'EPICRISIS' && tipoIncapacidad === 'Licencia de Paternidad') {
      return 'Resumen m√©dico que debe incluir las semanas de gestaci√≥n al momento del parto';
    }
    
    // Descripci√≥n espec√≠fica para Documento de Identidad en Licencia de Paternidad
    if (tipo === 'DOCUMENTO_IDENTIDAD' && tipoIncapacidad === 'Licencia de Paternidad') {
      return 'Fotocopia del documento de identidad de la madre del menor';
    }
    
    return config.descripcion;
  }
  
  // Funci√≥n para obtener nombre din√°mico seg√∫n el contexto
  function obtenerNombreDocumento(tipo, tipoIncapacidad) {
    const config = tiposDocumento[tipo];
    if (!config) return 'Documento';
    
    // Nombre espec√≠fico para Documento de Identidad en Licencia de Paternidad
    if (tipo === 'DOCUMENTO_IDENTIDAD' && tipoIncapacidad === 'Licencia de Paternidad') {
      return 'Documento de Identidad de la Madre';
    }
    
    return config.nombre;
  }
  
  todosDocumentos.forEach(({ tipo, obligatorio }) => {
    const config = tiposDocumento[tipo];
    if (!config) return;
    
    const cargado = documentosCargados[config.id] || false;
    const checkIcon = cargado ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted';
    const badgeClass = obligatorio ? 'bg-warning' : 'bg-info';
    const badgeText = obligatorio ? 'Obligatorio' : 'Condicional';
    
    const item = document.createElement('div');
    item.className = 'border rounded p-3 mb-2 documento-checklist-item';
    item.setAttribute('data-tipo', tipo);
    
    item.innerHTML = `
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi ${checkIcon} fs-5 me-3" id="check-${config.id}"></i>
          <div>
            <div class="fw-bold">
              <i class="bi ${config.icono} me-2"></i>
              ${obtenerNombreDocumento(tipo, document.getElementById('tipo').value)}
              <span class="badge ${badgeClass} ms-2">${badgeText}</span>
            </div>
            <div class="text-muted small">${obtenerDescripcionDocumento(tipo, document.getElementById('tipo').value)}</div>
          </div>
        </div>
        <div class="status-indicator" id="status-${config.id}">
          ${cargado ? 
            '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Cargado</span>' : 
            '<span class="badge bg-light text-dark">Pendiente</span>'
          }
        </div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

// UC5: Crear campos de entrada din√°micos
function crearCamposDocumentos() {
  const container = document.getElementById('campos-documentos');
  
  // Mantener el certificado existente
  const certificadoField = document.getElementById('field-certificado');
  
  // Limpiar otros campos
  const camposExistentes = container.querySelectorAll('.documento-field:not(#field-certificado)');
  camposExistentes.forEach(campo => campo.remove());
  
  const todosDocumentos = [
    ...documentosRequeridos.obligatorios?.map(tipo => ({ tipo, obligatorio: true })) || [],
    ...documentosRequeridos.condicionales?.map(tipo => ({ tipo, obligatorio: false })) || []
  ];
  
  // Actualizar badge del certificado para que sea consistente
  actualizarBadgeCertificado();
  
  todosDocumentos.forEach(({ tipo, obligatorio }) => {
    const config = tiposDocumento[tipo];
    if (!config || config.id === 'certificado') return; // Certificado ya existe
    
    const fieldId = `field-${config.id}`;
    
    // No duplicar campos existentes
    if (document.getElementById(fieldId)) return;
    
    const badgeClass = obligatorio ? 'bg-warning' : 'bg-info';
    const badgeText = obligatorio ? 'Obligatorio' : 'Condicional';
    
    const field = document.createElement('div');
    field.className = 'mb-4 documento-field';
    field.id = fieldId;
    
    field.innerHTML = `
      <label for="${config.id}" class="form-label fw-bold">
        <i class="bi ${config.icono} me-2"></i>
        ${obtenerNombreDocumento(tipo, document.getElementById('tipo').value)}
        <span class="badge ${badgeClass} ms-2">${badgeText}</span>
      </label>
      <input type="file" class="form-control documento-input" id="${config.id}" 
             name="${config.id}" accept=".pdf,.jpg,.jpeg,.png" 
             data-tipo="${tipo}" data-nombre="${obtenerNombreDocumento(tipo, document.getElementById('tipo').value)}">
      <div class="form-text">
        <i class="bi bi-info-circle me-1"></i>
        ${obtenerDescripcionDocumento(tipo, document.getElementById('tipo').value)}. Formato: PDF, JPG, PNG. M√°x: 10MB
      </div>
      <div class="preview-container mt-2" id="preview-${config.id}" style="display: none;"></div>
      <div class="invalid-feedback"></div>
    `;
    
    container.appendChild(field);
  });
}

// Funci√≥n para actualizar badge del certificado de manera consistente
function actualizarBadgeCertificado() {
  const badgeElement = document.getElementById('badge-certificado');
  if (!badgeElement) return;
  
  // Verificar si certificado es obligatorio en los documentos requeridos
  const certificadoObligatorio = documentosRequeridos.obligatorios?.includes('CERTIFICADO_INCAPACIDAD') || false;
  
  if (certificadoObligatorio) {
    badgeElement.className = 'badge bg-warning ms-2';
    badgeElement.textContent = 'Obligatorio';
  } else {
    badgeElement.className = 'badge bg-info ms-2';
    badgeElement.textContent = 'Condicional';
  }
}

// Funci√≥n para actualizar mensaje informativo seg√∫n documentos requeridos
function actualizarMensajeInformativo() {
  const infoElement = document.getElementById('info-documentos-opcional');
  if (!infoElement) return;
  
  const numObligatorios = documentosRequeridos.obligatorios?.length || 0;
  const numCondicionales = documentosRequeridos.condicionales?.length || 0;
  
  let mensaje = '';
  
  if (numObligatorios > 0) {
    mensaje = `
      <i class="bi bi-info-circle-fill me-2"></i>
      <strong>Importante:</strong> Para este tipo de incapacidad hay <strong>${numObligatorios} documento(s) obligatorio(s)</strong>`;
    
    if (numCondicionales > 0) {
      mensaje += ` y ${numCondicionales} condicional(es)`;
    }
    
    mensaje += `. Sin embargo, la carga es <strong>OPCIONAL</strong> en el registro inicial. 
      Si no tiene todos los documentos listos, puede registrar la incapacidad ahora y Gesti√≥n Humana le solicitar√°
      los documentos faltantes posteriormente.`;
    
    infoElement.className = 'alert alert-info mb-4';
  } else {
    mensaje = `
      <i class="bi bi-info-circle-fill me-2"></i>
      <strong>Importante:</strong> La carga de documentos es <strong>OPCIONAL</strong> en el registro inicial.
      Si no tiene todos los documentos listos, puede registrar la incapacidad ahora y Gesti√≥n Humana le solicitar√°
      los documentos faltantes posteriormente.`;
    
    infoElement.className = 'alert alert-warning mb-4';
  }
  
  infoElement.innerHTML = mensaje;
}

// UC5: Manejar cambio en documentos
function onDocumentoChange(input) {
  const fieldId = input.id;
  const file = input.files[0];
  const tipo = input.getAttribute('data-tipo');
  
  // Limpiar validaci√≥n previa
  input.classList.remove('is-valid', 'is-invalid');
  
  if (file) {
    // Validar archivo
    const validation = validarArchivo(file);
    if (!validation.valido) {
      input.classList.add('is-invalid');
      const feedbackEl = input.parentElement.querySelector('.invalid-feedback');
      if (feedbackEl) feedbackEl.textContent = validation.error;
      document.getElementById(`preview-${fieldId}`).style.display = 'none';
      
      // Actualizar estado
      documentosCargados[fieldId] = false;
    } else {
      input.classList.add('is-valid');
      mostrarPreview(fieldId, file);
      
      // Actualizar estado
      documentosCargados[fieldId] = true;
    }
  } else {
    document.getElementById(`preview-${fieldId}`).style.display = 'none';
    documentosCargados[fieldId] = false;
  }
  
  // Actualizar UI
  actualizarEstadoDocumento(fieldId, tipo);
  actualizarProgreso();
  validarFormularioCompleto();
}

// UC5: Actualizar estado visual de documento
function actualizarEstadoDocumento(fieldId, tipo) {
  const cargado = documentosCargados[fieldId] || false;
  
  // Actualizar checklist
  const checkIcon = document.getElementById(`check-${fieldId}`);
  const statusIndicator = document.getElementById(`status-${fieldId}`);
  
  if (checkIcon) {
    checkIcon.className = cargado ? 
      'bi bi-check-circle-fill text-success fs-5 me-3' : 
      'bi bi-circle text-muted fs-5 me-3';
  }
  
  if (statusIndicator) {
    statusIndicator.innerHTML = cargado ?
      '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Cargado</span>' :
      '<span class="badge bg-light text-dark">Pendiente</span>';
  }
}

// UC5: Actualizar indicador de progreso
function actualizarProgreso() {
  const todosDocumentos = [
    ...documentosRequeridos.obligatorios?.map(tipo => tiposDocumento[tipo]?.id).filter(Boolean) || [],
    ...documentosRequeridos.condicionales?.map(tipo => tiposDocumento[tipo]?.id).filter(Boolean) || []
  ];
  
  const totalDocumentos = todosDocumentos.length;
  const documentosCargadosCount = todosDocumentos.filter(id => documentosCargados[id]).length;
  
  const porcentaje = totalDocumentos > 0 ? Math.round((documentosCargadosCount / totalDocumentos) * 100) : 0;
  
  // Actualizar texto
  document.getElementById('progress-text').textContent = 
    `${documentosCargadosCount} de ${totalDocumentos} documentos`;
  
  // Actualizar barra de progreso
  const progressBar = document.getElementById('progress-bar');
  progressBar.style.width = `${porcentaje}%`;
  progressBar.setAttribute('aria-valuenow', porcentaje);
  
  // Cambiar color seg√∫n progreso
  progressBar.className = 'progress-bar';
  if (porcentaje === 100) {
    progressBar.classList.add('bg-success');
  } else if (porcentaje >= 50) {
    progressBar.classList.add('bg-info');
  } else {
    progressBar.classList.add('bg-warning');
  }
}

// UC5: Validaci√≥n del formulario antes del submit
function validarFormularioCompleto() {
  const alertContainer = document.getElementById('validation-alerts');
  alertContainer.innerHTML = '';
  
  // Verificar documentos obligatorios
  const obligatoriosFaltantes = [];
  
  if (documentosRequeridos.obligatorios) {
    documentosRequeridos.obligatorios.forEach(tipo => {
      const config = tiposDocumento[tipo];
      if (config && !documentosCargados[config.id]) {
        obligatoriosFaltantes.push(config.nombre);
      }
    });
  }
  
  // Mostrar alertas si hay documentos faltantes
  if (obligatoriosFaltantes.length > 0) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning';
    alert.innerHTML = `
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong>Documentos obligatorios pendientes:</strong>
      <ul class="mb-0 mt-2">
        ${obligatoriosFaltantes.map(nombre => `<li>${nombre}</li>`).join('')}
      </ul>
      <div class="small mt-2 text-muted">
        Puede registrar la incapacidad sin estos documentos. Gesti√≥n Humana los solicitar√° posteriormente.
      </div>
    `;
    alertContainer.appendChild(alert);
  } else {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success';
    alert.innerHTML = `
      <i class="bi bi-check-circle-fill me-2"></i>
      <strong>¬°Todos los documentos obligatorios est√°n cargados!</strong>
    `;
    alertContainer.appendChild(alert);
  }
  
  return obligatoriosFaltantes.length === 0;
}

// Funciones auxiliares
function mostrarInfoInicial() {
  document.getElementById('info-inicial').style.display = 'block';
  document.getElementById('documentos-requeridos').style.display = 'none';
  
  // Limpiar campos din√°micos
  const container = document.getElementById('campos-documentos');
  const camposExistentes = container.querySelectorAll('.documento-field:not(#field-certificado)');
  camposExistentes.forEach(campo => campo.remove());
  
  // Reset estado
  documentosRequeridos = {};
  documentosCargados = {};
}

function obtenerDiasIncapacidad() {
  const inicio = document.getElementById('fecha_inicio').value;
  const fin = document.getElementById('fecha_fin').value;
  
  if (inicio && fin) {
    const fechaInicio = new Date(inicio);
    const fechaFin = new Date(fin);
    const diff = fechaFin - fechaInicio;
    return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
  }
  
  return 0;
}

function calcularDias() {
  const inicio = document.getElementById('fecha_inicio').value;
  const fin = document.getElementById('fecha_fin').value;
  const container = document.getElementById('diasCalculados');
  
  if (inicio && fin) {
    const fechaInicio = new Date(inicio);
    const fechaFin = new Date(fin);
    const diff = fechaFin - fechaInicio;
    const dias = Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
    
    if (dias > 0) {
      document.getElementById('numeroDias').textContent = dias;
      document.getElementById('fechaInicioText').textContent = formatearFecha(inicio);
      document.getElementById('fechaFinText').textContent = formatearFecha(fin);
      container.style.display = 'block';
      
      // Si ya hay un tipo seleccionado, recargar documentos con los d√≠as actualizados
      const tipo = document.getElementById('tipo').value;
      if (tipo) {
        cargarDocumentosRequeridos(tipo).then(() => {
          actualizarUIDocumentos();
        });
      }
    } else {
      container.style.display = 'none';
      alert('‚ö†Ô∏è La fecha de fin debe ser posterior a la fecha de inicio.');
    }
  } else {
    container.style.display = 'none';
  }
}

function mostrarPreview(fieldId, file) {
  const previewContainer = document.getElementById(`preview-${fieldId}`);
  const fileType = file.type;
  const fileSize = (file.size / 1024).toFixed(2); // KB
  
  previewContainer.innerHTML = '';
  previewContainer.style.display = 'block';
  
  const previewCard = document.createElement('div');
  previewCard.className = 'card border-success';
  previewCard.style.maxWidth = '400px';
  
  let previewContent = '';
  
  // Preview seg√∫n tipo de archivo
  if (fileType.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      previewContent = `
        <div class="card-body p-2">
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <img src="${e.target.result}" alt="Preview" class="img-thumbnail" style="max-width: 120px; max-height: 120px;">
            </div>
            <div class="col">
              <div class="small">
                <strong>${file.name}</strong><br>
                <span class="text-muted">Tama√±o: ${fileSize} KB</span><br>
                <span class="badge bg-success">Imagen v√°lida</span>
              </div>
            </div>
          </div>
        </div>
      `;
      previewCard.innerHTML = previewContent;
    };
    reader.readAsDataURL(file);
  } else if (fileType === 'application/pdf') {
    previewContent = `
      <div class="card-body p-2">
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <i class="bi bi-file-pdf-fill text-danger" style="font-size: 4rem;"></i>
          </div>
          <div class="col">
            <div class="small">
              <strong>${file.name}</strong><br>
              <span class="text-muted">Tama√±o: ${fileSize} KB</span><br>
              <span class="badge bg-success">PDF v√°lido</span>
            </div>
          </div>
        </div>
      </div>
    `;
    previewCard.innerHTML = previewContent;
  } else {
    previewContent = `
      <div class="card-body p-2">
        <div class="small">
          <i class="bi bi-file-earmark-check text-success me-2"></i>
          <strong>${file.name}</strong> (${fileSize} KB)
        </div>
      </div>
    `;
    previewCard.innerHTML = previewContent;
  }
  
  previewContainer.appendChild(previewCard);
}

function handleSubmit(e) {
  e.preventDefault();
  
  // Limpiar errores previos
  document.getElementById('serverErrors').style.display = 'none';
  document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  
  // Validar fechas
  const fechaInicio = document.getElementById('fecha_inicio').value;
  const fechaFin = document.getElementById('fecha_fin').value;
  
  if (new Date(fechaFin) < new Date(fechaInicio)) {
    mostrarErroresServidor(['La fecha de fin debe ser posterior a la fecha de inicio']);
    return;
  }
  
  // UC5: Validaci√≥n cliente opcional (no bloqueante)
  const todosCompletos = validarFormularioCompleto();
  
  if (!todosCompletos) {
    // Mostrar confirmaci√≥n pero no bloquear
    if (!confirm('Hay documentos obligatorios pendientes. ¬øDesea continuar? Gesti√≥n Humana los solicitar√° posteriormente.')) {
      return;
    }
  }
  
  // Mostrar indicador de progreso
  document.getElementById('uploadProgress').style.display = 'block';
  document.getElementById('btnSubmit').disabled = true;
  
  // Enviar formulario
  const formData = new FormData(this);
  
  fetch(this.action || window.location.href, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('btnSubmit').disabled = false;
    
    if (data.success) {
      mostrarModalConfirmacion(data.codigo_radicacion);
    } else {
      mostrarErroresServidor(data.errors || ['Error al procesar la solicitud']);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('btnSubmit').disabled = false;
    mostrarErroresServidor(['Error de conexi√≥n. Por favor, intente nuevamente.']);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
}

function mostrarErroresServidor(errores) {
  const container = document.getElementById('serverErrors');
  const lista = document.getElementById('serverErrorsList');
  
  lista.innerHTML = '';
  errores.forEach(error => {
    const li = document.createElement('li');
    li.textContent = error;
    lista.appendChild(li);
  });
  
  container.style.display = 'block';
}

function mostrarModalConfirmacion(codigoRadicacion) {
  document.getElementById('codigoRadicacion').textContent = codigoRadicacion;
  const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
  modal.show();
}

function copiarCodigo() {
  const codigo = document.getElementById('codigoRadicacion').textContent;
  navigator.clipboard.writeText(codigo).then(() => {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copiado!';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
      btn.innerHTML = originalHTML;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  });
}

// Funci√≥n de formateo de fecha
function formatearFecha(fecha) {
  const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(fecha).toLocaleDateString('es-ES', opciones);
}

// Funci√≥n de validaci√≥n de archivo
function validarArchivo(file) {
  const maxSize = 10 * 1024 * 1024; // 10MB
  const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
  
  if (!file) {
    return { valido: false, error: 'No se seleccion√≥ ning√∫n archivo' };
  }
  
  if (file.size > maxSize) {
    return { valido: false, error: 'El archivo excede el tama√±o m√°ximo permitido (10MB)' };
  }
  
  if (!allowedTypes.includes(file.type)) {
    return { valido: false, error: 'Formato no permitido. Use PDF, JPG o PNG' };
  }
  
  return { valido: true };
}
</script>
{% endblock %}